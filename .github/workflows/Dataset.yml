name: Consolidation quotidienne des pr√©dictions

on:
  schedule:
    - cron: '0 5 * * *'  # Tous les jours √† 5h UTC (5h heure C√¥te d'Ivoire)
  workflow_dispatch:       # Permet aussi le lancement manuel

permissions:
  contents: write          # Autorise le push sur le d√©p√¥t

jobs:
  consolidate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout du d√©p√¥t
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          ref: main  # Change en "master" si ta branche principale s'appelle ainsi

      - name: Configuration de Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.12

      - name: Ex√©cution du script de consolidation
        run: |
          echo "üîÑ D√©marrage de la consolidation √† $(date)"
          python data.py >> consolidation.log 2>&1 || echo "‚ùå Erreur lors de l'ex√©cution du script"
          echo "‚úÖ Fin de l'ex√©cution du script"

      - name: Afficher le contenu du log
        run: |
          echo "üìÑ --- D√©but du fichier consolidation.log ---"
          cat consolidation.log || echo "‚ö†Ô∏è Aucun log trouv√©"
          echo "üìÑ --- Fin du fichier consolidation.log ---"

      - name: Commit et push des modifications
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # V√©rifie s'il y a eu des changements dans Analysesdata.json
          git add Analysesdata.json || true

          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è Aucune modification d√©tect√©e, aucun commit n√©cessaire."
          else
            git commit -m "üîÑ Mise √† jour quotidienne Analysesdata.json [$(date '+%Y-%m-%d %H:%M:%S')]"
            git push
            echo "‚úÖ Donn√©es consolid√©es et pouss√©es avec succ√®s."
          fi

      - name: Sauvegarder le fichier de log
        uses: actions/upload-artifact@v4
        with:
          name: consolidation-log
          path: consolidation.log